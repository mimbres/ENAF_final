![TensorFlow Requirement: 2.x](https://img.shields.io/badge/TensorFlow%20Requirement-2.x-brightgreen)
![TensorFlow 1 Not Supported](https://img.shields.io/badge/TensorFlow%201%20Not%20Supported-%E2%9C%95-red.svg)
<p align="center"> <img width="200" height="200" src="utils/logo/default.svg"> <p>

# ENAF: Efficient Neural Audio Fingerprint
* Efficient Neural Audio Fingerprint with self-supervised learning
* For benchmark, ["Now Playing"(B. Ag√ºera et al.)](https://arxiv.org/pdf/1711.10958.pdf): Deep Audio Fingerprint 

# Requirements
```
python==3.6
numpy
tensorflow-gpu==2.1.0
faiss-cpu==1.5.3
kapre==0.1.3.1
```
for MP3 support:
```
libsox-fmt-mp3
sox
```

# Install
```
conda create -n fingerprint python=3.6
conda activate fingerprint
conda install tensorflow-gpu=2.0.0
conda install -c conda-forge librosa
conda install numba==0.48
pip install kapre
conda install faiss-cpu -c pytorch
sudo apt-get install libsox-fmt-mp3 sox
sudo apt-get install libsndfile1
```

# Getting started with

## Train/validation/buildDB
```
USAGE:
    python train_with_EATS_v2fix_batch_semihard_320win1_d64.py <opt1:(str)EXP_NAME> <opt2:(int)EPOCH> <opt3:(str)TEST_MODE>

OPTIONS:
    - If <opt1:EXP_NAME> is given and pretrained model exists:
        - If <opt2> is empty, it continues training from the latest checkpoint.
        - Else if <opt2> is given, it continues training from the <opt2:EPOCH>.
    - If <opt1:EXP_NAME> is given and pretrained model doesn't exist, fresh start training.
    - If <opt1:EXP_NAME> is not given, EXP_NAME will be generated by dd/hh/mm/ss.
    - If <opt1>, <opt2> and <opt3:TEST_MODE> are given:
        - If <opt3:TEST_MODE> == "mini-test-only", it loads pre-trained model and proceed in-memory-search-mini-test, then quit.
        - If <opt3:TEST_MODE> == "mini-test", it tests while training.
        - If <opt3:TEST_MODE> == "save-db", it loads pre-trained model and only saves embeddings for DB as a numpy file.
        - If <opt3:TEST_MODE> == "save-db-query", it loads pre-trained model and saves embeddings for DB and Query as numpy files.
```

## Large-scale evaluation with FAISS
```
USAGE:
    python eval.py [argv1: EMBEDDING_DIR] [argv2: BATCH_SZ_QUERY]
    
    - argv1: (str) <Required> Embedding directory
    - argv2: (int) <optional> Size of batch for query processing. Larger batch
                   size uses larger memory. By default, 10.
    - argv3: (str) <optional> 'min': argmin-search (default)
                              'max': argmax-search for dot-product embeddings
```

## Quick-start
- Fresh-start with experiment name ('EXP1')
```
python train_with_EATS_v2fix_batch_semihard_320win1_d64.py EXP1
```

- Load weights and continue training
```
python train_with_EATS_v2fix_batch_semihard_320win1_d64.py EXP1
```

- Display learning-curve in Tensorboard
```
tensorboard --logdir=logs/fit --port=8900 --host=0.0.0.0
```

- Monitor TPU
```
capture_tpu_profile --tpu=TPU_NAME --monitoring_level=2
```

- Load pre-trained model at 20epoch, and perform mini-test (3K-DB)
```
python train_with_EATS_v2fix_batch_semihard_320win1_d64.py EXP1  '20' mini-test-only
```

- Load weigths from recent epoch, and perform mini-test 
```
python train_with_EATS_v2fix_batch_semihard_320win1_d64.py EXP1 mini-test-only
```
## DB construction
- Load trained model weights from 20 Epoch, and generate embeddings for DB and random queries.
```
python train_with_EATS_v2fix_batch_semihard_320win1_d64.py EXP1 '20' save-db-query
# Resulting embeddings will locate in logs/emb/<EXP NAME>/<EPOCH>/db.mm
```

## Large-scale Evaluation with [Faiss](https://github.com/facebookresearch/faiss)
```
python eval_faiss.py [argv1: EMBEDDING_DIR] [argv2: N_SAMPLE_TEST] [argv3: SEARCH_MODE]
```

- Exhaustive search with L2-distance (with 2000 test samples)
```
python eval_faiss.py logs/emb/EXP1/20 2000 l2 
```

- IVFPQ + Re-rank search (with 2000 test samples)
```
python eval_faiss.py logs/emb/EXP1/20 2000 ivfpq-rr
```
| SEARCH_MODE | Description |
| --- | --- |
| `l2` | *L2* distance|
| `ivf` | *Inverted File Index* |
| `pq` | Product Quantizaion |
| `ivfpq` | Product Quantizaion with IVF |
| `ivfpq-rr` | IVF-PQ with re-ranking |
| `ivfpq-rr-ondisk` | IVF-PQ with re-ranking on disk search |
| `hnsw` | Hierarchical Navigable Small World |
